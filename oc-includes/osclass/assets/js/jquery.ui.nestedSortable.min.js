!function($){$.widget("ui.nestedSortable",$.extend({},$.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"ui-nestedSortable-no-nesting",errorClass:"ui-nestedSortable-error",listType:"ol",maxLevels:0,noJumpFix:0},_create:function(){return 0==this.noJumpFix&&this.element.height(this.element.height()),this.element.data("sortable",this.element.data("nestedSortable")),$.ui.sortable.prototype._create.apply(this,arguments)},_mouseDrag:function(event){if(this.position=this._generatePosition(event),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll){var o=this.options,scrolled=!1;this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-event.pageY<o.scrollSensitivity?this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop+o.scrollSpeed:event.pageY-this.overflowOffset.top<o.scrollSensitivity&&(this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop-o.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-event.pageX<o.scrollSensitivity?this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft+o.scrollSpeed:event.pageX-this.overflowOffset.left<o.scrollSensitivity&&(this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft-o.scrollSpeed)):(event.pageY-$(document).scrollTop()<o.scrollSensitivity?scrolled=$(document).scrollTop($(document).scrollTop()-o.scrollSpeed):$(window).height()-(event.pageY-$(document).scrollTop())<o.scrollSensitivity&&(scrolled=$(document).scrollTop($(document).scrollTop()+o.scrollSpeed)),event.pageX-$(document).scrollLeft()<o.scrollSensitivity?scrolled=$(document).scrollLeft($(document).scrollLeft()-o.scrollSpeed):$(window).width()-(event.pageX-$(document).scrollLeft())<o.scrollSensitivity&&(scrolled=$(document).scrollLeft($(document).scrollLeft()+o.scrollSpeed))),!1!==scrolled&&$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,event)}this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px");for(var i=this.items.length-1;i>=0;i--){var item=this.items[i],itemElement=item.item[0],intersection=this._intersectsWithPointer(item);if(intersection&&!(itemElement==this.currentItem[0]||this.placeholder[1==intersection?"next":"prev"]()[0]==itemElement||$.contains(this.placeholder[0],itemElement)||"semi-dynamic"==this.options.type&&$.contains(this.element[0],itemElement))){if(this.direction=1==intersection?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(item))break;this._rearrange(event,item),this._clearEmpty(itemElement),this._trigger("change",event,this._uiHash());break}}var parentItem=this.placeholder[0].parentNode.parentNode&&$(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?$(this.placeholder[0].parentNode.parentNode):null,level=this._getLevel(this.placeholder),childLevels=this._getChildLevels(this.helper),previousItem=this.placeholder[0].previousSibling?$(this.placeholder[0].previousSibling):null;if(null!=previousItem)for(;"li"!=previousItem[0].nodeName.toLowerCase()||previousItem[0]==this.currentItem[0];){if(!previousItem[0].previousSibling){previousItem=null;break}previousItem=$(previousItem[0].previousSibling)}return newList=document.createElement(o.listType),this.beyondMaxLevels=0,null!=parentItem&&this.positionAbs.left<parentItem.offset().left?(parentItem.after(this.placeholder[0]),this._clearEmpty(parentItem[0]),this._trigger("change",event,this._uiHash())):null!=previousItem&&this.positionAbs.left>previousItem.offset().left+o.tabSize?(this._isAllowed(previousItem,level+childLevels+1),previousItem.children(o.listType).length||previousItem[0].appendChild(newList),previousItem.children(o.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",event,this._uiHash())):this._isAllowed(parentItem,level+childLevels),this._contactContainers(event),$.ui.ddmanager&&$.ui.ddmanager.drag(this,event),this._trigger("sort",event,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(event,noPropagation){if(this.beyondMaxLevels){for(var parent=this.placeholder.parent().closest(this.options.items),i=this.beyondMaxLevels-1;i>0;i--)parent=parent.parent().closest(this.options.items);this.placeholder.removeClass(this.options.errorClass),parent.after(this.placeholder),this._trigger("change",event,this._uiHash())}$.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(o){var items=this._getItemsAsjQuery(o&&o.connected),str=[];return o=o||{},$(items).each(function(){var res=($(o.item||this).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/),pid=($(o.item||this).parent(o.listType).parent("li").attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/);res&&str.push((o.key||res[1]+"["+(o.key&&o.expression?res[1]:res[2])+"]")+"="+(pid?o.key&&o.expression?pid[1]:pid[2]:"root"))}),!str.length&&o.key&&str.push(o.key+"="),str.join("&")},toHierarchy:function(o){function _recursiveItems(li){var id=($(li).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/);if(null!=id){var item={id:id[2]};return $(li).children(o.listType).children("li").length>0&&(item.children=[],$(li).children(o.listType).children("li").each(function(){var level=_recursiveItems($(this));item.children.push(level)})),item}}o=o||{};var ret=[];return $(this.element).children("li").each(function(){var level=_recursiveItems($(this));ret.push(level)}),ret},toArray:function(o){function _recursiveArray(item,depth,left){return right=left+1,$(item).children(o.listType).children("li").length>0&&(depth++,$(item).children(o.listType).children("li").each(function(){right=_recursiveArray($(this),depth,right)}),depth--),id=$(item).attr(o.attribute||"id").match(o.expression||/(.+)[-=_](.+)/),depth===sDepth+1?pid="root":(parentItem=$(item).parent(o.listType).parent("li").attr("id").match(o.expression||/(.+)[-=_](.+)/),pid=parentItem[2]),null!=id&&ret.push({item_id:id[2],parent_id:pid,depth:depth,left:left,right:right}),left=right+1}var sDepth=(o=o||{}).startDepthCount||0,ret=[],left=2;return ret.push({item_id:"root",parent_id:"none",depth:sDepth,left:"1",right:2*($("li",this.element).length+1)}),$(this.element).children("li").each(function(){left=_recursiveArray(this,sDepth+1,left)}),ret=ret.sort(function(a,b){return a.left-b.left})},_clear:function(event,noPropagation){$.ui.sortable.prototype._clear.apply(this,arguments);for(var i=this.items.length-1;i>=0;i--){var item=this.items[i].item[0];this._clearEmpty(item)}return!0},_clearEmpty:function(item){item.children[1]&&0==item.children[1].children.length&&item.removeChild(item.children[1])},_getLevel:function(item){var level=1;if(this.options.listType)for(var list=item.closest(this.options.listType);!list.is(".ui-sortable");)level++,list=list.parent().closest(this.options.listType);return level},_getChildLevels:function(parent,depth){var self=this,o=this.options,result=0;return depth=depth||0,$(parent).children(o.listType).children(o.items).each(function(index,child){result=Math.max(self._getChildLevels(child,depth+1),result)}),depth?result+1:result},_isAllowed:function(parentItem,levels){var o=this.options;null!=parentItem&&parentItem.hasClass(o.disableNesting)?(this.placeholder.addClass(o.errorClass),o.maxLevels<levels&&0!=o.maxLevels?this.beyondMaxLevels=levels-o.maxLevels:this.beyondMaxLevels=1):o.maxLevels<levels&&0!=o.maxLevels?(this.placeholder.addClass(o.errorClass),this.beyondMaxLevels=levels-o.maxLevels):(this.placeholder.removeClass(o.errorClass),this.beyondMaxLevels=0)}})),$.ui.nestedSortable.prototype.options=$.extend({},$.ui.sortable.prototype.options,$.ui.nestedSortable.prototype.options)}(jQuery);